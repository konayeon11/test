# -*- coding: utf-8 -*-
# app_gpt.py

import streamlit as st
import pandas as pd
import lightgbm as lgb
import json
import requests
from openai import OpenAI

# ==============================
# 🔑 API 키 불러오기
# ==============================
OPENAI_API_KEY = st.secrets.get("openai", {}).get("api_key")
HF_API_KEY = st.secrets.get("huggingface", {}).get("api_key")
HF_MODEL = st.secrets.get("huggingface", {}).get("model", "nvidia/Llama-3.3-Nemotron-Super-49B-v1.5")
HF_API_URL = st.secrets.get("huggingface", {}).get(
    "api_url", f"https://api-inference.huggingface.co/models/{HF_MODEL}"
)

# ✅ 백엔드 자동 선택
BACKEND = "hf" if HF_API_KEY else ("openai" if OPENAI_API_KEY else None)
if BACKEND is None:
    st.error("❌ 사용할 API 키가 없습니다. secrets.toml에 [huggingface.api_key] 또는 [openai.api_key]를 등록해주세요.")
    st.stop()

st.caption(f"⚙️ 현재 백엔드: {BACKEND.upper()}")

# ==============================
# 🧠 맞춤형 조언 생성 함수
# ==============================
def generate_lifestyle_advice(risk_factors: dict) -> str:
    risk_factors_str = json.dumps(risk_factors, ensure_ascii=False)

    prompt = f"""
당신은 심혈관질환 예방과 관리를 전문으로 하는 의료 전문가입니다.
환자의 위험 요인: {risk_factors_str}

다음 내용을 포함한 맞춤형 건강 처방을 제공하세요:
1) 위험 요인의 영향 (숫자·병태생리 포함, 1~2문장)
2) 위험 요인별 실천 방안 (일상 행동 + 효과 설명)
3) 개인화된 격려 메시지
4) 필요시 의료 조치 권고
5) 신뢰 가능한 참고자료 2~3개 (링크 포함)
6) 습관화를 위한 작은 성공 경험 제안
"""

    if BACKEND == "hf":
        # Hugging Face 호출
        try:
            resp = requests.post(
                HF_API_URL,
                headers={"Authorization": f"Bearer {HF_API_KEY}"},
                json={
                    "inputs": prompt,
                    "parameters": {
                        "max_new_tokens": 500,
                        "temperature": 0.7,
                        "repetition_penalty": 1.05,
                    },
                },
                timeout=120,
            )
            resp.raise_for_status()
            data = resp.json()
            if isinstance(data, list) and len(data) > 0 and "generated_text" in data[0]:
                return data[0]["generated_text"].strip()
            if isinstance(data, dict) and "error" in data:
                return f"⚠️ 모델 응답 대기 또는 오류: {data.get('error')}"
            return f"⚠️ 예상치 못한 응답: {data}"
        except Exception as e:
            return f"❌ Hugging Face 호출 실패: {str(e)}"

    else:
        # OpenAI 호출
        try:
            client = OpenAI(api_key=OPENAI_API_KEY)
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "당신은 심혈관질환 예방 및 관리에 전문성을 가진 의사입니다."},
                    {"role": "user", "content": prompt},
                ],
                temperature=0.7,
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            return f"❌ OpenAI 호출 실패: {str(e)}"

# ==============================
# 📊 데모용 LightGBM 모델
# ==============================
@st.cache_resource
def load_model():
    from sklearn.datasets import make_classification
    X, y = make_classification(n_samples=1000, n_features=11, random_state=42)
    lgb_train = lgb.Dataset(X, label=y)
    params = {"objective": "binary", "metric": "binary_logloss", "verbosity": -1}
    model = lgb.train(params, lgb_train, num_boost_round=10)
    return model

model = load_model()

# ==============================
# ⚖️ 입력값 전처리 함수
# ==============================
def classify_cholesterol(chol_value):
    if chol_value < 200: return 1
    elif 200 <= chol_value < 240: return 2
    else: return 3

def classify_gluc(gluc_value):
    if gluc_value < 100: return 1
    elif 100 <= gluc_value < 126: return 2
    else: return 3

# ==============================
# 🖥️ Streamlit UI
# ==============================
st.set_page_config(page_title="심혈관질환 예측기", layout="centered")
st.title("🩺 심혈관질환 10년 위험도 예측기")

st.header("📋 건강 정보 입력")
age = st.slider("나이", 20, 90, 50)
gender = st.radio("성별", ["남성", "여성"])
ap_hi = st.number_input("수축기 혈압", value=120)
ap_lo = st.number_input("이완기 혈압", value=80)
height_cm = st.number_input("키(cm)", value=170)
weight_kg = st.number_input("몸무게(kg)", value=65)
chol = st.number_input("콜레스테롤 수치 (mg/dL)", min_value=100, max_value=400, value=180)
gluc = st.number_input("혈당 수치 (공복 mg/dL)", min_value=50, max_value=300, value=90)
smoke = st.checkbox("흡연")
alco = st.checkbox("음주")
active = st.checkbox("활동적 생활")

# 입력 처리
bmi = weight_kg / ((height_cm / 100) ** 2) if height_cm else 0
gender_num = 1 if gender == "남성" else 0
chol_cat = classify_cholesterol(chol)
gluc_cat = classify_gluc(gluc)
hypertension = int(ap_hi >= 140 or ap_lo >= 90)

user_input = {
    "age_years": age,
    "gender": gender_num,
    "ap_hi": ap_hi,
    "ap_lo": ap_lo,
    "bmi": bmi,
    "cholesterol": chol_cat,
    "gluc": gluc_cat,
    "smoke": int(smoke),
    "alco": int(alco),
    "active": int(active),
    "hypertension": hypertension,
}

# 예측 함수
def predict_risk(model, user_input: dict):
    features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi",
                "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]
    df = pd.DataFrame([user_input])[features]
    return float(model.predict(df)[0])

# 버튼 동작
if st.button("🔍 위험도 예측"):
    risk = predict_risk(model, user_input)
    risk_percent = round(risk * 100, 2)
    st.subheader(f"📈 예측 결과: {risk_percent}%")

    risk_factors = {
        "고혈압": hypertension == 1,
        "흡연": smoke,
        "음주": alco,
        "비만": bmi >= 25,
        "고콜레스테롤": chol_cat >= 2,
        "고혈당": gluc_cat >= 2,
        "운동 부족": not active,
    }

    if risk_percent >= 15:
        st.warning("⚠️ 심혈관계 위험이 높은 편입니다. 생활습관 개선이 필요합니다.")
        st.markdown("💡 **맞춤형 건강 처방 (백엔드: {} 사용)**".format(BACKEND.upper()))
        with st.spinner("모델이 건강 조언을 생성 중입니다..."):
            advice = generate_lifestyle_advice(risk_factors)
            st.success("생활 처방 도착 ✅")
            st.markdown(advice)
    else:
        st.success("🎉 전반적으로 위험도가 낮습니다! 지금처럼 건강을 잘 유지하세요.")

st.markdown("---")
st.caption("🧠 Powered by LightGBM + OpenAI/HuggingFace (Nemotron 49B) | Made with ❤️ using Streamlit")
