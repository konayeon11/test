# -*- coding: utf-8 -*-
""".ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1nJCgTJE--_9H1x9gucjssNulcCgCytPU
"""

# app.py

import streamlit as st
import pandas as pd
import lightgbm as lgb
from openai import OpenAI
import os
import json

# âœ… OpenAI API Key ì„¤ì •

api_key = st.secrets["openai"]["api_key"]
client = OpenAI(api_key=api_key)
if not api_key:
    st.error("âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ 'OPENAI_API_KEY'ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    st.stop()

# âœ… GPT ê¸°ë°˜ ì¡°ì–¸ í•¨ìˆ˜
def generate_lifestyle_advice(risk_factors: dict):
    risk_factors_str = json.dumps(risk_factors, ensure_ascii=False)
    prompt = f"""
# ì—­í•  (Role)
ë‹¹ì‹ ì€ ì‹¬í˜ˆê´€ì§ˆí™˜ ì˜ˆë°©ê³¼ ê´€ë¦¬ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ì˜ë£Œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ìµœì‹  ì—°êµ¬ì™€ ì„ìƒ ì§€ì¹¨ì— ê¸°ë°˜í•˜ì—¬ ì¼ë°˜ì¸ì˜ ê±´ê°• í–‰ë™ì„ íš¨ê³¼ì ìœ¼ë¡œ ë³€í™”ì‹œí‚¬ ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì—­í• ì„ ë§¡ê³  ìˆìŠµë‹ˆë‹¤.

# ëŒ€ìƒ (Audience)
ë‹¹ì‹ ì˜ ì¡°ì–¸ì„ ë°›ì„ ëŒ€ìƒì€ ê±´ê°•ì— ê´€ì‹¬ì´ ë†’ì§€ë§Œ ì˜ë£Œ ì§€ì‹ì€ ë§ì§€ ì•Šì€ 40~60ëŒ€ ì¼ë°˜ í™˜ìì…ë‹ˆë‹¤.
ì´ í™˜ìëŠ” ìµœê·¼ ì‹¬í˜ˆê´€ ìœ„í—˜ í‰ê°€ë¥¼ ë°›ì•˜ìœ¼ë©°, ìì‹ ì˜ ìƒíƒœì— ë§ëŠ” ìƒí™œ ìŠµê´€ ê°œì„  ë°©ì•ˆì„ ì°¾ê³ ì í•©ë‹ˆë‹¤.

# ì…ë ¥ ì •ë³´ (Input)
ë‹¤ìŒì€ ì´ í™˜ìì˜ ì‹¬í˜ˆê´€ì§ˆí™˜ ê´€ë ¨ ì£¼ìš” ìœ„í—˜ ìš”ì¸ì…ë‹ˆë‹¤:
{risk_factors_str}

# ì‘ì—… ëª©í‘œ (Task)
ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬, í™˜ì ë§ì¶¤í˜• ê±´ê°• ì²˜ë°©ì„ ì œê³µí•˜ì„¸ìš”:

1. **ê° ìœ„í—˜ ìš”ì¸ì´ ì‹¬í˜ˆê´€ì§ˆí™˜ ë°œë³‘ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì„¤ëª…**
   - ë‹¨ìˆœíˆ "ìœ„í—˜í•˜ë‹¤"ê°€ ì•„ë‹ˆë¼, ì™œ ê·¸ëŸ°ì§€ ë³‘íƒœìƒë¦¬ì ìœ¼ë¡œ 1~2ë¬¸ì¥ ë‚´ì™¸ë¡œ ì„¤ëª…
   - ê°€ëŠ¥í•œ ê²½ìš° ìˆ«ì (ì˜ˆ: í˜ˆì•• 140 ì´ìƒì´ë©´ ìœ„í—˜ì´ 2ë°° ì¦ê°€) í™œìš©

2. **ê° ìœ„í—˜ ìš”ì¸ì„ ì¤„ì´ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì‹¤ì²œ ë°©ì•ˆ ì œì‹œ**
   - ë§¤ì¼ ê±·ê¸°, ì—¼ë¶„ ì¤„ì´ê¸° ë“± ì¼ìƒì—ì„œ ì‰½ê²Œ ì‹¤ì²œ ê°€ëŠ¥í•œ í–‰ë™ìœ¼ë¡œ
   - ê° í–‰ë™ì´ í•´ë‹¹ ìœ„í—˜ ìš”ì¸ì„ ì–´ë–»ê²Œ ê°œì„ í•˜ëŠ”ì§€ë„ ê°„ë‹¨íˆ ì„¤ëª…

3. **ê°œì¸í™”ëœ ì‹¤ì²œ íŒ ë˜ëŠ” ê²©ë ¤ ë©”ì‹œì§€ ì‚½ì…**
   - ì˜ˆ: "50ëŒ€ ì´í›„ì—ëŠ” í˜ˆì•• ê´€ë¦¬ê°€ íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤."
   - ëŒ€ìƒìì˜ ë‚˜ì´, ì„±ë³„, ìœ„í—˜ ì¡°í•© ë“±ì„ ê³ ë ¤í•œ ë§ì¶¤ ì½”ë©˜íŠ¸

4. **í•„ìš” ì‹œ ì˜ë£Œì  ì¡°ì¹˜ë‚˜ ì „ë¬¸ì˜ ìƒë‹´ ê¶Œê³  í¬í•¨**
   - íŠ¹ì • ìˆ˜ì¹˜(í˜ˆì••, í˜ˆë‹¹ ë“±)ê°€ ê¸°ì¤€ì¹˜ë¥¼ ë„˜ëŠ” ê²½ìš° ë³‘ì› ì§„ë£Œë¥¼ ê¶Œê³ 
   - ì•½ë¬¼ ì¹˜ë£Œ, í˜ˆì•¡ ê²€ì‚¬ ë“± ì‹¤ì œì  ì¡°ì¹˜ë„ ì–¸ê¸‰ ê°€ëŠ¥

5. **ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì°¸ê³  ìë£Œ 2~3ê°œ ì¶”ì²œ**
   - ìœ íŠœë¸Œ ì˜ìƒ: ì œëª©, ì„¤ëª…, ë§í¬
   - ê±´ê°• ì €ë„: ë…¼ë¬¸ ì œëª©, í•µì‹¬ ë‚´ìš©, ë§í¬
   - ê³µê³µê¸°ê´€ ê±´ê°• ì •ë³´ ì‚¬ì´íŠ¸ ë“±

6. **ìƒí™œìŠµê´€ ë³€í™” ìœ ì§€ë¥¼ ìœ„í•œ 'ì‘ì€ ì„±ê³µ ê²½í—˜' ì œì•ˆ**
   - í–‰ë™ì„ ìŠµê´€í™”í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì´ê³  ì¸¡ì • ê°€ëŠ¥í•œ ì˜ˆì‹œ í¬í•¨
   - ì˜ˆ: "ë§¤ì¼ ì•„ì¹¨ í˜ˆì•• ì¸¡ì •í•˜ê³  ê¸°ë¡í•˜ê¸°", "ì£¼ 3íšŒ ì¹œêµ¬ì™€ ê±·ê¸° ì±Œë¦°ì§€ ì°¸ì—¬"

# í˜•ì‹ ë° í†¤ (Format & Tone)
- ê° ìœ„í—˜ ìš”ì¸ì€ ë²ˆí˜¸ë‚˜ ì†Œì œëª©ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ëª…í™•í•˜ê²Œ êµ¬ì„±
- ì¤‘ìš”í•œ ì‹¤ì²œ í¬ì¸íŠ¸ëŠ” êµµì€ ê¸€ì”¨ë¡œ ê°•ì¡°
- ì„¤ëª…ì€ ì „ë¬¸ì„±ì„ ë‹´ë˜, ë°˜ë“œì‹œ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì“°ì„¸ìš”
- í•„ìš” ì‹œ ê°„ë‹¨í•œ ì˜ë£Œ ìš©ì–´ëŠ” ()ë‚˜ ì˜ˆì‹œë¡œ í’€ì–´ ì„¤ëª…
- ì „ì²´ ì–´ì¡°ëŠ” ì¹œì ˆí•˜ë©´ì„œë„ ì‹ ë¢°ê° ìˆëŠ” ì˜ë£Œ ì „ë¬¸ê°€ í†¤ ìœ ì§€
"""
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=1200,
        temperature=0.7
    )
    return response.choices[0].message.content.strip()

# âœ… ëª¨ë¸ ë¡œë“œ (ë°ëª¨ìš© LightGBM ëª¨ë¸ ìƒì„±)
@st.cache_resource
def load_model():
    from sklearn.datasets import make_classification
    X, y = make_classification(n_samples=1000, n_features=11)
    lgb_train = lgb.Dataset(X, label=y)
    params = {"objective": "binary", "metric": "binary_logloss", "verbosity": -1}
    model = lgb.train(params, lgb_train, num_boost_round=10)
    return model

model = load_model()

# âœ… ì‚¬ìš©ì ì…ë ¥ UI
st.set_page_config(page_title="ì‹¬í˜ˆê´€ì§ˆí™˜ ì˜ˆì¸¡ê¸°", layout="centered")
st.title("ğŸ«€ ì‹¬í˜ˆê´€ì§ˆí™˜ 10ë…„ ìœ„í—˜ë„ ì˜ˆì¸¡ê¸°")
st.markdown("ê±´ê°• ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ 10ë…„ ë‚´ ì‹¬í˜ˆê´€ì§ˆí™˜ ìœ„í—˜ì„ ì˜ˆì¸¡í•˜ê³ , í•„ìš” ì‹œ GPT ê¸°ë°˜ **ë§ì¶¤í˜• ê±´ê°• ì¡°ì–¸**ì„ ì œê³µí•©ë‹ˆë‹¤.")

st.header("ğŸ“‹ ê±´ê°• ì •ë³´ ì…ë ¥")
age = st.slider("ë‚˜ì´", 20, 90, 50)
gender = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
ap_hi = st.number_input("ìˆ˜ì¶•ê¸° í˜ˆì••", value=120)
ap_lo = st.number_input("ì´ì™„ê¸° í˜ˆì••", value=80)
height_cm = st.number_input("í‚¤(cm)", value=170)
weight_kg = st.number_input("ëª¸ë¬´ê²Œ(kg)", value=65)
chol = st.radio("ì½œë ˆìŠ¤í…Œë¡¤ ìˆ˜ì¹˜", ["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"])
gluc = st.radio("í˜ˆë‹¹ ìˆ˜ì¹˜", ["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"])
smoke = st.checkbox("í¡ì—°")
alco = st.checkbox("ìŒì£¼")
active = st.checkbox("í™œë™ì  ìƒí™œ")

# âœ… ì…ë ¥ ì²˜ë¦¬
bmi = weight_kg / ((height_cm / 100) ** 2) if height_cm else 0
gender_num = 1 if gender == "ë‚¨ì„±" else 0
chol_map = {"ì •ìƒ": 1, "ê²½ê³„": 2, "ë†’ìŒ": 3}
gluc_map = {"ì •ìƒ": 1, "ê²½ê³„": 2, "ë†’ìŒ": 3}
hypertension = int(ap_hi >= 140 or ap_lo >= 90)

user_input = {
    "age_years": age,
    "gender": gender_num,
    "ap_hi": ap_hi,
    "ap_lo": ap_lo,
    "bmi": bmi,
    "cholesterol": chol_map[chol],
    "gluc": gluc_map[gluc],
    "smoke": int(smoke),
    "alco": int(alco),
    "active": int(active),
    "hypertension": hypertension
}

# âœ… ìœ„í—˜ ì˜ˆì¸¡
def predict_risk(model, user_input: dict):
    features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi",
                "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]
    df = pd.DataFrame([user_input])
    return model.predict(df)[0]

if st.button("ğŸ” ìœ„í—˜ë„ ì˜ˆì¸¡"):
    risk = predict_risk(model, user_input)
    risk_percent = round(risk * 100, 2)
    st.subheader(f"ğŸ“ˆ ì˜ˆì¸¡ ê²°ê³¼: {risk_percent}%")

    risk_factors = {
        "ê³ í˜ˆì••": hypertension == 1,
        "í¡ì—°": smoke,
        "ìŒì£¼": alco,
        "ë¹„ë§Œ": bmi >= 25,
        "ê³ ì½œë ˆìŠ¤í…Œë¡¤": chol_map[chol] >= 2,
        "ê³ í˜ˆë‹¹": gluc_map[gluc] >= 2,
        "ìš´ë™ ë¶€ì¡±": not active,
    }

    if risk_percent >= 15:
        st.warning("âš ï¸ ì‹¬í˜ˆê´€ê³„ ìœ„í—˜ì´ ë†’ì€ í¸ì…ë‹ˆë‹¤. ìƒí™œìŠµê´€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        st.markdown("ğŸ’¡ **GPT ê¸°ë°˜ ë§ì¶¤í˜• ê±´ê°• ì²˜ë°©**")
        with st.spinner("GPTê°€ ê±´ê°• ì¡°ì–¸ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
            advice = generate_lifestyle_advice(risk_factors)
            st.success("ìƒí™œ ì²˜ë°© ë„ì°© âœ…")
            st.markdown(advice)
    else:
        st.success("ğŸ‰ ì „ë°˜ì ìœ¼ë¡œ ìœ„í—˜ë„ê°€ ë‚®ìŠµë‹ˆë‹¤! ì§€ê¸ˆì²˜ëŸ¼ ê±´ê°•ì„ ì˜ ìœ ì§€í•˜ì„¸ìš”.")

st.markdown("---")
st.caption("ğŸ§  Powered by LightGBM + GPT-4o | Made with â¤ï¸ using Streamlit")