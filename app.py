# -*- coding: utf-8 -*-
"""ì „ì´í•™ìŠµ.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1CYTj91HJscsjDuPMll05SqKdbtslsb8Z
"""

!pip install lightgbm

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
import lightgbm as lgb
import matplotlib.pyplot as plt
import seaborn as sns

#import kagglehub

# Download latest version
#path = kagglehub.dataset_download("sulianova/cardiovascular-disease-dataset")

#print("Path to dataset files:", path)

import pandas as pd
import os

# ì „ì²´ ê²½ë¡œ ì§€ì •
#csv_path = os.path.join(path, "cardio_train.csv")

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
#df = pd.read_csv(csv_path, sep=';')

df = pd.read_csv("cardio_train.csv", sep=';')

print(df.head())

"""# ì „ì²˜ë¦¬"""

#1. ê²°ì¸¡ì¹˜ëŠ” ì´ë¯¸ ì—†ì–´ì„œ ìƒëžµ
#2. ì´ìƒì¹˜ ì²˜ë¦¬
#ë‚˜ì´ê°€ ì¼ìˆ˜ë¡œ ë˜ì–´ìžˆì–´ ë…„ìˆ˜ë¡œ ë°”ê¿ˆ
df['age'] = (df['age'] / 365).astype(int)
df['age']

#ë¹„í˜„ì‹¤ì ì¸ í‚¤/ëª¸ë¬´ê²Œ ì œê±°
df = df[(df['height'] > 100) & (df['height'] < 250)]
df = df[(df['weight'] > 30) & (df['weight'] < 250)]

# BMI íŒŒìƒ ë³€ìˆ˜ ì¶”ê°€
df['bmi'] = df['weight'] / ((df['height'] / 100) ** 2)

# ì´ìƒì¹˜ ì œê±°
df = df[(df["ap_hi"] >= 90) & (df["ap_hi"] <= 200)]
df = df[(df["ap_lo"] >= 60) & (df["ap_lo"] <= 130)]
df = df[(df["bmi"] >= 10) & (df["bmi"] <= 60)]

df["hypertension"] = ((df["ap_hi"] >= 140) | (df["ap_lo"] >= 90)).astype(int)

df

features = [
    "age", "gender", "height", "weight", "ap_hi", "ap_lo",
    "cholesterol", "gluc", "smoke", "alco", "active", "bmi", "hypertension"
]
X = df[features]
y = df["cardio"]

# 4. ì „ì´í•™ìŠµ ì‹œë®¬ë ˆì´ì…˜: source vs target ë¶„í• (í•˜ë‚˜ì˜ ë°ì´í„°ë¥¼ ê°€ì§€ê³ )
X_source, X_target, y_source, y_target = train_test_split(X, y, test_size=0.2, stratify=y, random_state=42)

# 5. ëª¨ë¸ í•™ìŠµ (LightGBM)
lgb_train = lgb.Dataset(X_source, label=y_source)
params = {
    "objective": "binary",
    "metric": "binary_logloss",
    "verbosity": -1
}
model = lgb.train(params, lgb_train, num_boost_round=100)

# 6. ì„±ëŠ¥ í‰ê°€
y_pred = model.predict(X_target)
y_pred_class = (y_pred > 0.5).astype(int)

from sklearn.metrics import classification_report
print(classification_report(y_target, y_pred_class))

# 7. ì¤‘ìš” ë³€ìˆ˜ ì‹œê°í™”
lgb.plot_importance(model, max_num_features=10, importance_type='gain')
plt.title("Top Feature Importances")
plt.show()

def predict_risk(user_input: dict, model, feature_cols):
    # ìž…ë ¥ê°’ì„ DataFrameìœ¼ë¡œ ë³€í™˜
    df = pd.DataFrame([user_input])

    # íŒŒìƒ ë³€ìˆ˜ ì¶”ê°€
    df["bmi"] = df["weight"] / ((df["height"] / 100) ** 2)
    df["hypertension"] = ((df["ap_hi"] >= 140) | (df["ap_lo"] >= 90)).astype(int)

    # ëˆ„ë½ëœ feature ì±„ìš°ê¸° (ê¸°ë³¸ê°’ 0)
    for col in feature_cols:
        if col not in df.columns:
            df[col] = 0

    # feature ìˆœì„œ ë§žì¶”ê¸°
    df = df[feature_cols]

    # ì˜ˆì¸¡
    prob = model.predict(df)[0]

    # feature importance ê¸°ë°˜ ìƒìœ„ ìœ„í—˜ ìš”ì†Œ ì¶”ì¶œ
    importances = model.feature_importance(importance_type='gain')
    feature_importance_dict = dict(zip(feature_cols, importances))

    sorted_importance = sorted(feature_importance_dict.items(), key=lambda x: x[1], reverse=True)

    top_features = {}
    for name, _ in sorted_importance[:5]:
        top_features[name] = df[name].values[0]

    return {
        "risk_probability": round(prob, 3),
        "top_risk_features": top_features
    }

# ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ ë°ì´í„° (ì˜ˆì‹œ)
user_example = {
    "age_years": 45,
    "gender": 2,
    "height": 160,
    "weight": 70,
    "ap_hi": 145,
    "ap_lo": 95,
    "cholesterol": 2,
    "gluc": 1,
    "smoke": 1,
    "alco": 0,
    "active": 0
}

result = predict_risk(user_example, model, feature_cols=features)

print(" ì˜ˆì¸¡ëœ ì‹¬í˜ˆê´€ê³„ ì§ˆí™˜ ìœ„í—˜ë„:", result["risk_probability"])
print(" ì£¼ìš” ìœ„í—˜ ìš”ì¸:")
for k, v in result["top_risk_features"].items():
    print(f"  - {k}: {v}")

"""# framingham ë°ì´í„°ì— ì „ì´"""

# 1. ë°ì´í„° ê²½ë¡œ ì„¤ì •
import kagglehub
import os
import pandas as pd
import numpy as np

# framingham ë°ì´í„° ë‹¤ìš´ë¡œë“œ
#framingham_path = kagglehub.dataset_download("aasheesh200/framingham-heart-study-dataset")
#print(" Framingham íŒŒì¼ ìœ„ì¹˜:", framingham_path)

# ë°ì´í„° ë‹¤ìš´ë¡œë“œ
#path = kagglehub.dataset_download("sulianova/cardiovascular-disease-dataset")
#cardio_path = os.path.join(path, "cardio_train.csv")

# cardio ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
#cardio_df = pd.read_csv(cardio_path, sep=';')
cardio_df = pd.read_csv("cardio_train.csv", sep=';')

# framingham ë°ì´í„° ë¡œë“œ
#framingham_df = pd.read_csv(os.path.join(framingham_path, "framingham.csv"))
framingham_df = pd.read_csv("framingham.csv")

# cardio ì „ì²˜ë¦¬
cardio_df["age_years"] = (cardio_df["age"] / 365).astype(int)
cardio_df["bmi"] = cardio_df["weight"] / ((cardio_df["height"] / 100) ** 2)
cardio_df["hypertension"] = ((cardio_df["ap_hi"] >= 140) | (cardio_df["ap_lo"] >= 90)).astype(int)

# ì´ìƒì¹˜ ì œê±°
cardio_df = cardio_df[(cardio_df["ap_hi"] >= 90) & (cardio_df["ap_hi"] <= 200)]
cardio_df = cardio_df[(cardio_df["ap_lo"] >= 60) & (cardio_df["ap_lo"] <= 130)]
cardio_df = cardio_df[(cardio_df["bmi"] >= 10) & (cardio_df["bmi"] <= 60)]

# íƒ€ê²Ÿê³¼ í”¼ì²˜ ì„¤ì •
cardio_features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi", "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]
X_cardio = cardio_df[cardio_features]
y_cardio = cardio_df["cardio"]

# ëˆ„ë½ ì œê±°
framingham_df = framingham_df.dropna()

# ì»¬ëŸ¼ëª… í†µì¼ ë° ë³€í™˜
framingham_df["age_years"] = framingham_df["age"]
framingham_df["gender"] = framingham_df["male"] + 1  # 1=ì—¬ìž, 2=ë‚¨ìžë¡œ ë³€í™˜
framingham_df["ap_hi"] = framingham_df["sysBP"]
framingham_df["ap_lo"] = framingham_df["diaBP"]
framingham_df["bmi"] = framingham_df["BMI"]

# 4. 'cholesterol' ë²”ì£¼í™” í•¨ìˆ˜
def cholesterol_category(total_chol):
    if total_chol < 200:
        return 1
    elif total_chol < 240:
        return 2
    else:
        return 3

framingham_df["cholesterol"] = framingham_df["totChol"].apply(cholesterol_category)

# 5. 'gluc' ë²”ì£¼í™” í•¨ìˆ˜
def glucose_category(glucose):
    if glucose < 100:
        return 1
    elif glucose < 126:
        return 2
    else:
        return 3

# 7. 'alco' ìŒì£¼ ì—¬ë¶€: 'currentDrinker' ì»¬ëŸ¼ì´ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ 0 ì²˜ë¦¬
if "currentDrinker" in framingham_df.columns:
    framingham_df["alco"] = framingham_df["currentDrinker"].astype(int)
else:
    framingham_df["alco"] = 0

# 8. 'active' í™œë™ëŸ‰: 'physicalActivity' ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ 1ë¡œ ê¸°ë³¸ê°’ ì§€ì •
if "physicalActivity" in framingham_df.columns:
    framingham_df["active"] = framingham_df["physicalActivity"].apply(lambda x: 1 if x else 0)
else:
    framingham_df["active"] = 1

framingham_df["gluc"] = framingham_df["glucose"].apply(glucose_category)
framingham_df["smoke"] = framingham_df["currentSmoker"]

# 9. ê³ í˜ˆì•• ë³€ìˆ˜ ì •ì˜
framingham_df["hypertension"] = ((framingham_df["ap_hi"] >= 140) | (framingham_df["ap_lo"] >= 90)).astype(int)

# 10. íƒ€ê²Ÿ ë³€ìˆ˜ ë° í”¼ì²˜ ì„¸íŠ¸ ì¤€ë¹„
framingham_df = framingham_df.dropna(subset=["TenYearCHD"])  # íƒ€ê²Ÿ ê²°ì¸¡ ì œê±°

framingham_df["hypertension"] = ((framingham_df["ap_hi"] >= 140) | (framingham_df["ap_lo"] >= 90)).astype(int)

# íƒ€ê²Ÿ
y_fram = framingham_df["TenYearCHD"]
X_fram = framingham_df[cardio_features]

from sklearn.model_selection import train_test_split
import lightgbm as lgb
from sklearn.metrics import classification_report

# source ë°ì´í„° í•™ìŠµ
train_data = lgb.Dataset(X_cardio, label=y_cardio)
params = {
    "objective": "binary",
    "metric": "binary_logloss",
    "verbosity": -1
}
model = lgb.train(params, train_data, num_boost_round=100)

# target ë°ì´í„°ë¡œ ì˜ˆì¸¡
y_pred = model.predict(X_fram)
y_pred_label = (y_pred > 0.5).astype(int)

# ê²°ê³¼ í‰ê°€
print(" Framingham ë°ì´í„°ì…‹ì—ì„œ ì „ì´í•™ìŠµ ì„±ëŠ¥:")
print(classification_report(y_fram, y_pred_label))

# ì¤‘ìš” í”¼ì²˜ ì‹œê°í™”
import matplotlib.pyplot as plt
lgb.plot_importance(model, max_num_features=10)
plt.title("Feature Importance (from cardio_train model)")
plt.show()

def predict_risk(model, user_input: dict):
    """
    model: LightGBM í•™ìŠµ ëª¨ë¸
    user_input: ì‚¬ìš©ìž ìž…ë ¥ ë”•ì…”ë„ˆë¦¬
      ì˜ˆ) {
          "age_years": 55,
          "gender": 1,  # ë‚¨ì„±=1, ì—¬ì„±=0
          "ap_hi": 130,
          "ap_lo": 85,
          "bmi": 24.5,
          "cholesterol": 2,  # 1=ì •ìƒ, 2=ê²½ê³„, 3=ë†’ìŒ
          "gluc": 1,
          "smoke": 0,
          "alco": 0,
          "active": 1,
          "hypertension": 0
      }
    ë°˜í™˜: 10ë…„ ì‹¬í˜ˆê´€ì§ˆí™˜ ë°œë³‘ í™•ë¥  (0~1)
    """

    import pandas as pd

    # ëª¨ë¸ í•™ìŠµì‹œ ì‚¬ìš©í•œ í”¼ì²˜ ìˆœì„œì— ë§žì¶° DataFrame ìƒì„±
    features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi",
                "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]

    # ë”•ì…”ë„ˆë¦¬ì—ì„œ í•´ë‹¹ í”¼ì²˜ ê°’ë§Œ ì¶”ì¶œ
    data = {feat: [user_input.get(feat, 0)] for feat in features}

    input_df = pd.DataFrame(data)

    # ëª¨ë¸ ì˜ˆì¸¡ (í™•ë¥ )
    risk_prob = model.predict(input_df)[0]  # ë‹¨ì¼ ìƒ˜í”Œì´ë¼ ì¸ë±ì‹±

    return risk_prob

#ì˜ˆì‹œ
user_input = {
    "age_years": 60,
    "gender": 1,
    "ap_hi": 140,
    "ap_lo": 90,
    "bmi": 27.5,
    "cholesterol": 3,
    "gluc": 2,
    "smoke": 1,
    "alco": 0,
    "active": 0,
    "hypertension": 1
}

risk = predict_risk(model, user_input)
print(f"ì˜ˆì¸¡ëœ 10ë…„ ì‹¬í˜ˆê´€ì§ˆí™˜ ìœ„í—˜ë„: {risk*100:.2f}%")

"""# GPT ì—°ë™ â†’ ìœ„í—˜ìš”ì¸ ê¸°ë°˜ ìƒí™œ ì²˜ë°© ìƒì„± í•¨ìˆ˜"""

from openai import OpenAI
import openai

import os
from openai import OpenAI

api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

import os
os.environ["OPENAI_API_KEY"] = api_key

client = OpenAI()

openai.api_key = api_key

def generate_lifestyle_advice(risk_factors: dict):
    """
    risk_factors: ì˜ˆ) {"ê³ í˜ˆì••": True, "í¡ì—°": True, "ë‹¹ë‡¨": False, ...}
    GPTì—ê²Œ ìƒí™œ ì²˜ë°© ìš”ì²­

    ë°˜í™˜: GPTê°€ ìƒì„±í•œ ìƒí™œ ì²˜ë°© í…ìŠ¤íŠ¸
    """
    prompt = f"""
ë‹¹ì‹ ì€ ì „ë¬¸ ì‹¬ë¦¬ìƒë‹´ê°€ì´ìž ìž„ìƒì˜ì–‘ì‚¬ì´ë©° ì‹¬í˜ˆê´€ ì§ˆí™˜ ì˜ˆë°© ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.
ì•„ëž˜ í™˜ìžì˜ ìœ„í—˜ ìš”ì¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì¹œì ˆí•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ë§žì¶¤í˜• ìƒí™œ ì²˜ë°©ì„ ìž‘ì„±í•´ ì£¼ì„¸ìš”.

- í™˜ìžì˜ ìœ„í—˜ ìš”ì¸: {risk_factors}
- í™˜ìžëŠ” ì‹¬ë¦¬ì ìœ¼ë¡œ ë¶ˆì•ˆì •í•œ ìƒíƒœìž„ì„ ê°ì•ˆí•˜ì—¬ ìœ„ë¡œì™€ ë™ê¸°ë¶€ì—¬ ë¬¸êµ¬ë¥¼ í¬í•¨í•˜ì„¸ìš”.
- ìƒí™œ ìŠµê´€ ê°œì„ ì„ ìœ„í•œ êµ¬ì²´ì ì¸ ë‹¨ê³„ë³„ ì‹¤ì²œ ë°©ë²•ì„ ê¶Œê³ í•˜ê³ ,
- ë‹¨ìˆœ ë‚˜ì—´ì´ ì•„ë‹ˆë¼ 'ì™œ' ê·¸ëŸ° í–‰ë™ì´ ì¤‘ìš”í•œì§€ë„ ê°„ëžµížˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
- ê°€ëŠ¥í•œ í•œ ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ì–´ì¡°ë¡œ ìž‘ì„±í•´ ì£¼ì„¸ìš”.
- ë§ˆì§€ë§‰ì— ê°„ë‹¨í•œ ìš”ì•½ê³¼ í•¨ê»˜ ìž‘ì€ ì„±ê³µ ê²½í—˜ì„ ìŒ“ì„ ìˆ˜ ìžˆëŠ” ì œì•ˆë„ í¬í•¨í•˜ì„¸ìš”.
- ë¶ˆí•„ìš”í•˜ê²Œ ì „ë¬¸ ìš©ì–´ë¥¼ ì“°ì§€ ë§ê³ , ëˆ„êµ¬ë‚˜ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìžˆë„ë¡ ìž‘ì„±í•˜ì„¸ìš”.
"""

    response = client.chat.completions.create(
      model="gpt-4o",
      messages=[{"role": "user", "content": prompt}],
      max_tokens=1000,
      temperature=0.7
    )
    advice = response.choices[0].message.content.strip()
    return advice

"""# Gradio"""

import gradio as gr

def predict_risk(model, user_input: dict):
    import pandas as pd
    features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi",
                "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]
    data = {feat: [user_input.get(feat, 0)] for feat in features}
    input_df = pd.DataFrame(data)
    risk_prob = model.predict(input_df)[0]
    return risk_prob

def wrapper(age, gender, ap_hi, ap_lo, bmi, chol, gluc, smoke, alco, active):
    try:
        gender_num = 1 if gender == "ë‚¨ì„±" else 0
        chol_map = {"ì •ìƒ":1, "ê²½ê³„":2, "ë†’ìŒ":3}
        gluc_map = {"ì •ìƒ":1, "ê²½ê³„":2, "ë†’ìŒ":3}
        hypertension = 1 if (ap_hi >= 140 or ap_lo >= 90) else 0

        user_input = {
            "age_years": age,
            "gender": gender_num,
            "ap_hi": ap_hi,
            "ap_lo": ap_lo,
            "bmi": bmi,
            "cholesterol": chol_map[chol],
            "gluc": gluc_map[gluc],
            "smoke": int(smoke),
            "alco": int(alco),
            "active": int(active),
            "hypertension": hypertension
        }

        # ìœ„í—˜ë„ ì˜ˆì¸¡
        risk = predict_risk(model, user_input)
        risk_percent = round(risk * 100, 2)
        risk_msg = f"10ë…„ ë‚´ ì‹¬í˜ˆê´€ì§ˆí™˜ ë°œë³‘ ìœ„í—˜ë„: **{risk_percent}%**\n"

        # ìœ„í—˜ìš”ì¸ ì¶”ì¶œ
        risk_factors = {
            "ê³ í˜ˆì••": hypertension == 1,
            "í¡ì—°": smoke,
            "ìŒì£¼": alco,
            "ë¹„ë§Œ": bmi >= 25,
            "ê³ ì½œë ˆìŠ¤í…Œë¡¤": chol_map[chol] >= 2,
            "ê³ í˜ˆë‹¹": gluc_map[gluc] >= 2,
            "ìš´ë™ ë¶€ì¡±": not active,
        }

        # ìœ„í—˜ë„ê°€ ë†’ì„ ê²½ìš°ì—ë§Œ GPT ì¡°ì–¸ ìƒì„±
        if risk_percent >= 15:
            advice = generate_lifestyle_advice(risk_factors)
            return risk_msg + "\n\në§žì¶¤í˜• ìƒí™œì²˜ë°©:\n" + advice
        else:
            return risk_msg + "\nì „ë°˜ì ìœ¼ë¡œ ìœ„í—˜ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ê±´ê°•í•œ ìƒí™œìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”!"

    except Exception as e:
        import traceback
        print("ðŸ”¥ wrapper í•¨ìˆ˜ì—ì„œ ì˜¤ë¥˜ ë°œìƒ:")
        traceback.print_exc()
        return f"âš ï¸ ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ: {e}"

# Gradio ì¸í„°íŽ˜ì´ìŠ¤ ì •ì˜
demo = gr.Interface(
    fn=wrapper,
    inputs=[
        gr.Slider(20, 90, value=50, label="ë‚˜ì´"),
        gr.Radio(["ë‚¨ì„±", "ì—¬ì„±"], label="ì„±ë³„"),
        gr.Number(label="ìˆ˜ì¶•ê¸° í˜ˆì•• (ap_hi)", value=120),
        gr.Number(label="ì´ì™„ê¸° í˜ˆì•• (ap_lo)", value=80),
        gr.Number(label="BMI", value=22.0),
        gr.Radio(["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"], label="ì½œë ˆìŠ¤í…Œë¡¤ ìˆ˜ì¤€"),
        gr.Radio(["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"], label="í˜ˆë‹¹ ìˆ˜ì¤€"),
        gr.Checkbox(label="í¡ì—° ì—¬ë¶€"),
        gr.Checkbox(label="ìŒì£¼ ì—¬ë¶€"),
        gr.Checkbox(label="í™œë™ì  ì—¬ë¶€")
    ],
    outputs="text",
    title="ì‹¬í˜ˆê´€ì§ˆí™˜ 10ë…„ ì˜ˆì¸¡ê¸° (Gradio ë²„ì „)"
)

demo.launch()

"""# streamlit + cloudflared"""

!pip install streamlit

!wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
!chmod +x cloudflared

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# # streamlit_app.py
# 
# import streamlit as st
# import pandas as pd
# import lightgbm as lgb
# import matplotlib.pyplot as plt
# 
# # ðŸ’¡ GPT ê¸°ë°˜ ì¡°ì–¸ í•¨ìˆ˜
# from openai import OpenAI
# 
# # OpenAI í´ë¼ì´ì–¸íŠ¸ ìƒì„± (í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEYë¡œ í‚¤ ì„¤ì • ê¶Œìž¥)
# client = OpenAI(api_key=api_key)
# 
# def generate_lifestyle_advice(risk_factors: dict):
#     import json
#     risk_factors_str = json.dumps(risk_factors, ensure_ascii=False)
#     prompt = f"""
# # ì—­í•  (Role)
# ë‹¹ì‹ ì€ ì‹¬í˜ˆê´€ì§ˆí™˜ ì˜ˆë°©ê³¼ ê´€ë¦¬ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ì˜ë£Œ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.
# ìµœì‹  ì—°êµ¬ì™€ ìž„ìƒ ì§€ì¹¨ì— ê¸°ë°˜í•˜ì—¬ ì¼ë°˜ì¸ì˜ ê±´ê°• í–‰ë™ì„ íš¨ê³¼ì ìœ¼ë¡œ ë³€í™”ì‹œí‚¬ ìˆ˜ ìžˆë„ë¡ ë•ëŠ” ì—­í• ì„ ë§¡ê³  ìžˆìŠµë‹ˆë‹¤.
# 
# # ëŒ€ìƒ (Audience)
# ë‹¹ì‹ ì˜ ì¡°ì–¸ì„ ë°›ì„ ëŒ€ìƒì€ ê±´ê°•ì— ê´€ì‹¬ì´ ë†’ì§€ë§Œ ì˜ë£Œ ì§€ì‹ì€ ë§Žì§€ ì•Šì€ 40~60ëŒ€ ì¼ë°˜ í™˜ìžìž…ë‹ˆë‹¤.
# ì´ í™˜ìžëŠ” ìµœê·¼ ì‹¬í˜ˆê´€ ìœ„í—˜ í‰ê°€ë¥¼ ë°›ì•˜ìœ¼ë©°, ìžì‹ ì˜ ìƒíƒœì— ë§žëŠ” ìƒí™œ ìŠµê´€ ê°œì„  ë°©ì•ˆì„ ì°¾ê³ ìž í•©ë‹ˆë‹¤.
# 
# # ìž…ë ¥ ì •ë³´ (Input)
# ë‹¤ìŒì€ ì´ í™˜ìžì˜ ì‹¬í˜ˆê´€ì§ˆí™˜ ê´€ë ¨ ì£¼ìš” ìœ„í—˜ ìš”ì¸ìž…ë‹ˆë‹¤:
# {risk_factors}
# 
# # ìž‘ì—… ëª©í‘œ (Task)
# ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬, í™˜ìž ë§žì¶¤í˜• ê±´ê°• ì²˜ë°©ì„ ì œê³µí•˜ì„¸ìš”:
# 
# 1. **ê° ìœ„í—˜ ìš”ì¸ì´ ì‹¬í˜ˆê´€ì§ˆí™˜ ë°œë³‘ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì„¤ëª…**
#    - ë‹¨ìˆœížˆ "ìœ„í—˜í•˜ë‹¤"ê°€ ì•„ë‹ˆë¼, ì™œ ê·¸ëŸ°ì§€ ë³‘íƒœìƒë¦¬ì ìœ¼ë¡œ 1~2ë¬¸ìž¥ ë‚´ì™¸ë¡œ ì„¤ëª…
#    - ê°€ëŠ¥í•œ ê²½ìš° ìˆ«ìž (ì˜ˆ: í˜ˆì•• 140 ì´ìƒì´ë©´ ìœ„í—˜ì´ 2ë°° ì¦ê°€) í™œìš©
# 
# 2. **ê° ìœ„í—˜ ìš”ì¸ì„ ì¤„ì´ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì‹¤ì²œ ë°©ì•ˆ ì œì‹œ**
#    - ë§¤ì¼ ê±·ê¸°, ì—¼ë¶„ ì¤„ì´ê¸° ë“± ì¼ìƒì—ì„œ ì‰½ê²Œ ì‹¤ì²œ ê°€ëŠ¥í•œ í–‰ë™ìœ¼ë¡œ
#    - ê° í–‰ë™ì´ í•´ë‹¹ ìœ„í—˜ ìš”ì¸ì„ ì–´ë–»ê²Œ ê°œì„ í•˜ëŠ”ì§€ë„ ê°„ë‹¨ížˆ ì„¤ëª…
# 
# 3. **ê°œì¸í™”ëœ ì‹¤ì²œ íŒ ë˜ëŠ” ê²©ë ¤ ë©”ì‹œì§€ ì‚½ìž…**
#    - ì˜ˆ: "50ëŒ€ ì´í›„ì—ëŠ” í˜ˆì•• ê´€ë¦¬ê°€ íŠ¹ížˆ ì¤‘ìš”í•©ë‹ˆë‹¤."
#    - ëŒ€ìƒìžì˜ ë‚˜ì´, ì„±ë³„, ìœ„í—˜ ì¡°í•© ë“±ì„ ê³ ë ¤í•œ ë§žì¶¤ ì½”ë©˜íŠ¸
# 
# 4. **í•„ìš” ì‹œ ì˜ë£Œì  ì¡°ì¹˜ë‚˜ ì „ë¬¸ì˜ ìƒë‹´ ê¶Œê³  í¬í•¨**
#    - íŠ¹ì • ìˆ˜ì¹˜(í˜ˆì••, í˜ˆë‹¹ ë“±)ê°€ ê¸°ì¤€ì¹˜ë¥¼ ë„˜ëŠ” ê²½ìš° ë³‘ì› ì§„ë£Œë¥¼ ê¶Œê³ 
#    - ì•½ë¬¼ ì¹˜ë£Œ, í˜ˆì•¡ ê²€ì‚¬ ë“± ì‹¤ì œì  ì¡°ì¹˜ë„ ì–¸ê¸‰ ê°€ëŠ¥
# 
# 5. **ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” ì°¸ê³  ìžë£Œ 2~3ê°œ ì¶”ì²œ**
#    - ìœ íŠœë¸Œ ì˜ìƒ: ì œëª©, ì„¤ëª…, ë§í¬
#    - ê±´ê°• ì €ë„: ë…¼ë¬¸ ì œëª©, í•µì‹¬ ë‚´ìš©, ë§í¬
#    - ê³µê³µê¸°ê´€ ê±´ê°• ì •ë³´ ì‚¬ì´íŠ¸ ë“±
# 
# 6. **ìƒí™œìŠµê´€ ë³€í™” ìœ ì§€ë¥¼ ìœ„í•œ 'ìž‘ì€ ì„±ê³µ ê²½í—˜' ì œì•ˆ**
#    - í–‰ë™ì„ ìŠµê´€í™”í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì´ê³  ì¸¡ì • ê°€ëŠ¥í•œ ì˜ˆì‹œ í¬í•¨
#    - ì˜ˆ: "ë§¤ì¼ ì•„ì¹¨ í˜ˆì•• ì¸¡ì •í•˜ê³  ê¸°ë¡í•˜ê¸°", "ì£¼ 3íšŒ ì¹œêµ¬ì™€ ê±·ê¸° ì±Œë¦°ì§€ ì°¸ì—¬"
# 
# # í˜•ì‹ ë° í†¤ (Format & Tone)
# - ê° ìœ„í—˜ ìš”ì¸ì€ ë²ˆí˜¸ë‚˜ ì†Œì œëª©ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ëª…í™•í•˜ê²Œ êµ¬ì„±
# - ì¤‘ìš”í•œ ì‹¤ì²œ í¬ì¸íŠ¸ëŠ” êµµì€ ê¸€ì”¨ë¡œ ê°•ì¡°
# - ì„¤ëª…ì€ ì „ë¬¸ì„±ì„ ë‹´ë˜, ë°˜ë“œì‹œ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìžˆë„ë¡ ì“°ì„¸ìš”
# - í•„ìš” ì‹œ ê°„ë‹¨í•œ ì˜ë£Œ ìš©ì–´ëŠ” ()ë‚˜ ì˜ˆì‹œë¡œ í’€ì–´ ì„¤ëª…
# - ì „ì²´ ì–´ì¡°ëŠ” ì¹œì ˆí•˜ë©´ì„œë„ ì‹ ë¢°ê° ìžˆëŠ” ì˜ë£Œ ì „ë¬¸ê°€ í†¤ ìœ ì§€
# 
# """
#     response = client.chat.completions.create(
#         model="gpt-4o",
#         messages=[{"role": "user", "content": prompt}],
#         max_tokens=1000,
#         temperature=0.7
#     )
#     return response.choices[0].message.content.strip()
# 
# 
# # âœ… ìœ„í—˜ ì˜ˆì¸¡ í•¨ìˆ˜
# def predict_risk(model, user_input: dict):
#     features = ["age_years", "gender", "ap_hi", "ap_lo", "bmi",
#                 "cholesterol", "gluc", "smoke", "alco", "active", "hypertension"]
#     data = {feat: [user_input.get(feat, 0)] for feat in features}
#     input_df = pd.DataFrame(data)
#     risk_prob = model.predict(input_df)[0]
#     return risk_prob
# 
# # âœ… ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸° (í•™ìŠµëœ ëª¨ë¸ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ìž„ì‹œë¡œ ë‹¤ì‹œ í•™ìŠµ)
# @st.cache_resource
# def load_model():
#     from sklearn.datasets import make_classification
#     import lightgbm as lgb
# 
#     # ê°€ì§œ ë°ì´í„°ë¡œ ëª¨ë¸ êµ¬ì„± (ì‹¤ì œ ì½”ë“œì—ì„  í•™ìŠµëœ ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ì„¸ìš”)
#     X, y = make_classification(n_samples=1000, n_features=11)
#     lgb_train = lgb.Dataset(X, label=y)
#     params = {"objective": "binary", "metric": "binary_logloss", "verbosity": -1}
#     model = lgb.train(params, lgb_train, num_boost_round=10)
#     return model
# 
# model = load_model()
# 
# # âœ… Streamlit íŽ˜ì´ì§€ êµ¬ì„±
# st.set_page_config(page_title="ì‹¬í˜ˆê´€ì§ˆí™˜ ì˜ˆì¸¡ê¸°", layout="centered")
# 
# st.title("ðŸ«€ ì‹¬í˜ˆê´€ì§ˆí™˜ 10ë…„ ìœ„í—˜ë„ ì˜ˆì¸¡ê¸°")
# st.markdown("ê±´ê°• ì •ë³´ë¥¼ ìž…ë ¥í•˜ë©´ 10ë…„ ë‚´ ì‹¬í˜ˆê´€ì§ˆí™˜ ìœ„í—˜ì„ ì˜ˆì¸¡í•˜ê³ , í•„ìš” ì‹œ GPT ê¸°ë°˜ **ë§žì¶¤í˜• ê±´ê°• ì¡°ì–¸**ì„ ì œê³µí•©ë‹ˆë‹¤.")
# 
# st.header("ðŸ“‹ ê±´ê°• ì •ë³´ ìž…ë ¥")
# 
# # ðŸ‘‰ ì‚¬ìš©ìž ìž…ë ¥
# age = st.slider("ë‚˜ì´", 20, 90, 50)
# gender = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
# ap_hi = st.number_input("ìˆ˜ì¶•ê¸° í˜ˆì•• (ap_hi)", value=120)
# ap_lo = st.number_input("ì´ì™„ê¸° í˜ˆì•• (ap_lo)", value=80)
# 
# height_cm = st.number_input("í‚¤ (cm)", value=170)
# weight_kg = st.number_input("ëª¸ë¬´ê²Œ (kg)", value=65)
# 
# chol = st.radio("ì½œë ˆìŠ¤í…Œë¡¤ ìˆ˜ì¹˜", ["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"])
# gluc = st.radio("í˜ˆë‹¹ ìˆ˜ì¹˜", ["ì •ìƒ", "ê²½ê³„", "ë†’ìŒ"])
# smoke = st.checkbox("í¡ì—°")
# alco = st.checkbox("ìŒì£¼")
# active = st.checkbox("í™œë™ì  ìƒí™œ")
# 
# # ðŸ‘‰ BMI ê³„ì‚°
# if height_cm > 0:
#     height_m = height_cm / 100
#     bmi = weight_kg / (height_m ** 2)
# else:
#     bmi = 0
# 
# # ðŸ‘‰ ìž…ë ¥ ë³€í™˜
# gender_num = 1 if gender == "ë‚¨ì„±" else 0
# chol_map = {"ì •ìƒ": 1, "ê²½ê³„": 2, "ë†’ìŒ": 3}
# gluc_map = {"ì •ìƒ": 1, "ê²½ê³„": 2, "ë†’ìŒ": 3}
# hypertension = 1 if (ap_hi >= 140 or ap_lo >= 90) else 0
# 
# user_input = {
#     "age_years": age,
#     "gender": gender_num,
#     "ap_hi": ap_hi,
#     "ap_lo": ap_lo,
#     "bmi": bmi,
#     "cholesterol": chol_map[chol],
#     "gluc": gluc_map[gluc],
#     "smoke": int(smoke),
#     "alco": int(alco),
#     "active": int(active),
#     "hypertension": hypertension
# }
# 
# if st.button("ðŸ” ìœ„í—˜ë„ ì˜ˆì¸¡"):
#     risk = predict_risk(model, user_input)
#     risk_percent = round(risk * 100, 2)
#     st.subheader(f"ðŸ“ˆ ì˜ˆì¸¡ ê²°ê³¼: {risk_percent}%")
# 
#     risk_factors = {
#         "ê³ í˜ˆì••": hypertension == 1,
#         "í¡ì—°": smoke,
#         "ìŒì£¼": alco,
#         "ë¹„ë§Œ": bmi >= 25,
#         "ê³ ì½œë ˆìŠ¤í…Œë¡¤": chol_map[chol] >= 2,
#         "ê³ í˜ˆë‹¹": gluc_map[gluc] >= 2,
#         "ìš´ë™ ë¶€ì¡±": not active,
#     }
# 
#     if risk_percent >= 15:
#         st.warning("âš ï¸ ìœ„í—˜ë„ê°€ ë†’ìŠµë‹ˆë‹¤. ê±´ê°• ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
#         st.markdown("ðŸ’¡ **GPT ê¸°ë°˜ ë§žì¶¤í˜• ìƒí™œ ì¡°ì–¸**")
#         with st.spinner("GPTì—ê²Œ ì¡°ì–¸ì„ ìš”ì²­ ì¤‘..."):
#             advice = generate_lifestyle_advice(risk_factors)
#             st.success("ìƒí™œ ì²˜ë°©ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤:")
#             st.markdown(advice)
#     else:
#         st.success("ðŸŽ‰ ì „ë°˜ì ìœ¼ë¡œ ìœ„í—˜ë„ê°€ ë‚®ìŠµë‹ˆë‹¤! ì§€ê¸ˆì²˜ëŸ¼ ê±´ê°•ì„ ìž˜ ìœ ì§€í•˜ì„¸ìš”.")
# 
# st.markdown("---")
# st.caption("ðŸ§  Powered by LightGBM + GPT-4o | Made with â¤ï¸ using Streamlit")

!wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
!chmod +x cloudflared

!streamlit run app.py --server.address 0.0.0.0 &>/dev/null &

!nohup ./cloudflared tunnel --url http://localhost:8501 &> tunnel.log &

!grep "trycloudflare.com" tunnel.log